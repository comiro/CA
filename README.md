# Own Certificate Authority (CA)
–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ—Ä–Ω–µ–≤—ã–º —Ü–µ–Ω—Ç—Ä–æ–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏.

CA —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏, –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è –ø–æ –≤—ã–ø—É—Å–∫—É –∏ –æ—Ç–∑—ã–≤—É —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ —Å—É—â–µ—Å—Ç–≤—É—é—Ç —Ç–æ–ª—å–∫–æ –≤ –≤–∏–¥–µ ci —Å–∫—Ä–∏–ø—Ç–∞ –∏ –∑–∞–¥–∞–Ω–∏–π.
–ö–æ—Ä–Ω–µ–≤–æ–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Ç–∞–∫–∂–µ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –ø–æ–º–æ—â–∏ ci –∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ –Ω–≤–µ–Ω—Ç–æ—Ä–∏ —Ñ–∞–π–ª –∏–ª–∏ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª —Å ip –∞–¥—Ä–µ—Å–∞–º–∏,
–Ω–∞ –∫–æ—Ç–æ—Ä—ã—Ö –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω SSH –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –¥–ª—è –∞–Ω—Å–∏–±–ª.

## üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ—Ä–Ω–µ–≤–æ–≥–æ CA

‚úÖ –î–µ–ø–ª–æ–π –∫–æ—Ä–Ω–µ–≤–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –Ω–∞ –≤—Å–µ —Ö–æ—Å—Ç—ã

‚úÖ –í—ã–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ (—Å SAN)

‚úÖ –í—ã–ø—É—Å–∫ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤

‚úÖ –û—Ç–∑—ã–≤ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è CRL

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–π–ø–ª–∞–π–Ω–∞
Stages:
- root-ca - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ—Ä–Ω–µ–≤—ã–º CA

- new-certs - –≤—ã–ø—É—Å–∫ –Ω–æ–≤—ã—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤

- revoke-certs - –æ—Ç–∑—ã–≤ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤

## üîê –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ GitLab CI
–ì—Ä—É–ø–ø–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (Settings ‚Üí CI/CD ‚Üí Variables):

|–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
| ------ | ------ | ------ |
| CA_CERT | –ü—É–±–ª–∏—á–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∫–æ—Ä–Ω–µ–≤–æ–≥–æ CA | –°–æ–¥–µ—Ä–∂–∏–º–æ–µ root-ca.crt.pem |
| SSH_KEY | –ü—Ä–∏–≤–∞—Ç–Ω—ã–π SSH –∫–ª—é—á –¥–ª—è –¥–µ–ø–ª–æ—è | –°–æ–¥–µ—Ä–∂–∏–º–æ–µ SSH –∫–ª—é—á–∞ |
| SSH_USER | ssh –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å | ansible –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å |
| HOSTS | —Ñ–∞–π–ª —Å–æ —Å–ø–∏—Å–∫–æ–º IP —Ö–æ—Å—Ç–æ–≤ –¥–ª—è –¥–µ–ø–ª–æ—è –∫–æ—Ä–Ω–µ–≤–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –∏ crl | –º–æ–∂–Ω–æ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è –∏–Ω–≤–µ–Ω—Ç–æ—Ä–∏ |

–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞
|–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
| --------- | ---------- | -------- |
| CA_KEY | –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –∫–æ—Ä–Ω–µ–≤–æ–≥–æ CA | –°–æ–¥–µ—Ä–∂–∏–º–æ–µ root-ca.key.pem |
| CA_PASS | –ü–∞—Ä–æ–ª—å –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è CA –∫–ª—é—á–∞ | my-secret-password |
| push_token | GitLab token –¥–ª—è push –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π | glpat-xxxxxx |
| openssl_cnf | —Ñ–∞–π–ª —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ CA | —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ openssl.conf |

–ø—Ä–∏–º–µ—Ä openssl_cnf
```
[ ca ]
default_ca = own_CA

[ home_CA ]
dir               = .
crl_dir           = $dir/crl
new_certs_dir     = $dir/newcerts
database          = $dir/index.txt
serial            = $dir/serial

private_key       = $dir/private/root-ca.key.pem
certificate       = $dir/certs/root-ca.crt.pem

default_days      = 365
default_crl_days  = 30
default_md        = sha256

policy            = policy_simple

email_in_dn       = no
name_opt          = ca_default
cert_opt          = ca_default
copy_extensions   = copy
preserve          = no
rand_serial       = no

[ policy_simple ]
commonName              = supplied  # –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è SUBJECT –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å —É–∫–∞–∑–∞–Ω–∞

[ req ]
default_bits        = 2048

[ server_cert ]
basicConstraints  = CA:FALSE
keyUsage          = digitalSignature, keyEncipherment
extendedKeyUsage  = serverAuth
```
Runtime –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (—É–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –¥–∂–æ–±—ã):
| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
| --------- | ---------- | -------- |
| SUBJECT | –ò–º—è –¥–ª—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ | gitlab.local, user1 |
| BAD | –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è –æ—Ç–∑—ã–≤–∞ | compromised.crt |

## üõ†Ô∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
  1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è CA

   –ó–∞–ø—É—Å—Ç–∏ –¥–∂–æ–±—É create_ca_cert_and_key
   –°–æ—Ö—Ä–∞–Ω–∏ –≤—ã–≤–æ–¥ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:
     - CA_KEY (–ø—Ä–æ–µ–∫—Ç–Ω–∞—è)
     - CA_CERT (–≥—Ä—É–ø–ø–æ–≤–∞—è)
     - CA_PASS (–ø—Ä–æ–µ–∫—Ç–Ω–∞—è)

  2. –î–µ–ø–ª–æ–π CA –Ω–∞ —Ö–æ—Å—Ç—ã

     - –°–æ–∑–¥–∞–π –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é HOSTS —Å–æ —Å–ø–∏—Å–∫–æ–º —Ö–æ—Å—Ç–æ–≤

       ```
       192.168.1.10
       192.168.1.20
       ```

     - –ó–∞–ø—É—Å—Ç–∏ deploy_ca_cert_on_hosts

  3. –í—ã–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞

     –ó–∞–ø—É—Å—Ç–∏ create_new_site_cert —Å –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π SUBJECT

     –∫ –ø—Ä–∏–º–µ—Ä—É SUBJECT="gitlab.local"

  4. –í—ã–ø—É—Å–∫ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞

     –ó–∞–ø—É—Å—Ç–∏ create_new_user_cert —Å –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π SUBJECT
     SUBJECT="alex"

  5. –û—Ç–∑—ã–≤ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞

     –ó–∞–ø—É—Å—Ç–∏ revoke_cert —Å –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π BAD

     BAD="compromised.crt"

## üìã –§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞

  - newcerts - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏
  - crl - –ø–∞–ø–∫–∞ —Å–æ —Å–ø–∏—Å–∫–æ–º –æ—Ç–æ–∑–≤–∞–Ω–Ω—ã—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤


## üîß –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

 - Gitlab
 - GitLab Runner —Å —Ç–µ–≥–æ–º test-runner
 - –î–æ—Å—Ç—É–ø –ø–æ SSH –∫ —Ü–µ–ª–µ–≤—ã–º —Ö–æ—Å—Ç–∞–º
 - Alpine Linux –æ–±—Ä–∞–∑ —Å openssl/openssh –∏ –∏—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∫–æ—Ä–Ω–µ–≤—ã–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º

## üí° –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

  - –°–µ—Ä–≤–µ—Ä–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á–∞—é—Ç SAN
  - –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ Git
  - CRL –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –æ—Ç–∑—ã–≤–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π CA

## üö® –í–∞–∂–Ω–æ

 - –•—Ä–∞–Ω–∏—Ç–µ CA_PASS –∏ SSH_KEY –≤ —Å–µ–∫—Ä–µ—Ç–∞—Ö
 - –†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ CRL –Ω–∞ —Ö–æ—Å—Ç–∞—Ö
 - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–∞–∑–Ω—ã–µ RUNNER—ã –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
 - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫—É –∏—Å—Ç–æ—Ä–∏–∏ –ø–∞–π–ø–ª–∞–π–Ω–æ–≤ –≤ –≥–∏—Ç–ª–∞–±–µ
